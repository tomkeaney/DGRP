---
title: "Estimating 'SNP-heritability'"
site: workflowr::wflow_site
editor_options:
  chunk_output_type: console
---

```{r, setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, warning = FALSE#, results='hide'
)
```

# Prepare for `GCTA` analysis

$~$

## Load packages and build helper functions

$~$

Here we load the necessary packages to build this document and code in 'tidy' style. We also set the file path so that R can access the `gcta64` software. Finally, we build a helper function to pass `GCTA` commands to the terminal. This function allows us to code entirely within R-studio, which is our preference.

```{r}
library(tidyverse)
library(glue)
library(kableExtra)
library(DT)

gcta <- file.path(getwd(), "code/gcta64")
options(readr.show_col_types = FALSE)


# helper function to pass commands to the terminal
# Note that we set `intern = TRUE`, and pass the result of `system()` to `cat()`,
# ensuring that the Terminal output will be printed in this knitr report.
run_command <- function(shell_command, wd = getwd(), path = ""){
  cat(system(glue("cd ", wd, path, "\n",shell_command), intern = TRUE), sep = '\n')
}

```

$~$

## Load and clean phenotype data

$~$

Here we load in the unscaled phenotype data we collated [here](Data_collation.html). 

- We then trim the dataset to only include traits that are measured across \>80 lines. 

- Two traits cause GCTA to call an error: `paraquat.resistance.2021.f` & `starvation.resistance.high.carb.diet.m`. We simply do not estimate heritability for these two traits. The error is _Error: the information matrix is not invertible._

This takes the number of traits from 1214 to 972. 

We then fix the names of traits and DGRP lines to conform with `GCTA` and `Plink` e.g. */* is not an acceptable file name, and line is required in front of the line number e.g. `line21`.

```{r}
traits <- read_csv("data/derived/all.dgrp.phenos_unscaled.csv") 

traits_for_analysis <- 
  traits %>% 
  group_by(Trait) %>% 
  summarise(lines_measured = length(unique(line))) %>% 
  ungroup() %>% 
  filter(lines_measured > 79) %>%
  filter(Trait != "paraquat.resistance.2021.f" & Trait != "starvation.resistance.high.carb.diet.m") %>% # these traits call a gcta error, we remove them
  pull(Trait) # find traits with 80+ replicates

# replace any slashes in the trait name, e.g. "1/3-Methylhistidine.high.yeast.f", as this is not ok to use as a file name
traits_for_analysis <- str_replace_all(traits_for_analysis, "[/]", "_") 

line_mean_phenotypes <- traits %>%
  mutate(Trait = str_replace_all(Trait, "[/]", "_")) %>%  # change to match `traits_for_analysis` list
  filter(Trait %in% traits_for_analysis) %>%
  select(line, Trait, trait_value) %>% 
  spread(Trait, trait_value) %>% 
  mutate_at(vars(-line), ~ as.numeric(scale(.x))) %>%  # scale the traits
  mutate(line = paste("line", line, sep = "")) # add "line" in front of the line number to fit with plink/gcta formatting
```

$~$

# Use `GCTA` to estimate the genetic variances and heritabilities for each trait

$~$

Here we estimate 'SNP-heritability' for each phenotype using a Genomic relatedness matrix REstricted Maximum Likelihood (GREML) approach. GREML uses a set of SNPs $S$ that are known across a population of individuals (or DGRP lines, in our case) to estimate the relatedness between random individuals (lines) and compares that with their phenotypic similarity. This allows us to estimate the variation in phenotype that is explained by the known set of SNPs in our population. We can then divide this variance by the total variation found for the phenotype, giving the 'SNP-heritability', $h^2_{SNP}$. Note that SNP-heritability should be smaller than other estimates of heritability such as broad- or narrow-sense heritability, as it is limited to additive effects from **known** SNPs (and unknown causal variants in close linkage with these), while the latter two estimates encompass a more-complete range of genetic effects. 

We use the `GCTA` software to run this analysis. 

## Make a genomic relatedness matrix for all the lines

This uses the `GCTA` command `--make-grm` to make a genomic relatedness matrix (GRM) for the DGRP SNP data. This matrix is needed to run the GREML models below.

```{r}
run_command(glue("{gcta} --bfile dgrp2_QC_all_lines",
                 " --make-grm",
                 " --out gcta_GRM"), path = "/data/gwas_data/derived/")
```

## Run univariate GREML models to find heritabilites

The below uses the `GCTA` command --reml to estimate the genetic variance (V(G)), environmental variance (V(e)), their sum (Vp), and the so-called “SNP heritability” (V(G)/Vp).

```{r}

do_univariate_greml <- function(trait1){

  # First make 'focal_data', a 2-column data frame with the line and the focal phenotype value
  focal_data <- line_mean_phenotypes %>%
    select(line, !! trait1)
  names(focal_data)[2] <- c("focal_phenotype")
  
  # Write a file with the line and phenotype data called phenotype.txt, for gcta64
  pheno_data <- focal_data %>%
    # filter(!(line %in% lines_to_prune)) %>% 
    mutate(line_copy = line) %>%
    select(line, line_copy, focal_phenotype) %>%
    as.matrix()
  
  pheno_data %>%
    write.table(row.names = FALSE, col.names = FALSE,
                file = "data/gwas_data/derived/phenotype.txt", quote = FALSE)
  
  console_output <- suppressWarnings(capture.output(
    run_command(glue("{gcta}  --reml --reml-maxit 10000 --grm gcta_GRM  --pheno phenotype.txt  --out delete_me"), 
                path = "/data/gwas_data/derived/")))
  
  errors <- console_output[str_detect(console_output, "[Ee]rror")]
  if(length(errors) == 0) errors <- NA
  if(length(errors) > 1) errors <- paste(errors, sep = "; ")

  rbind(read.delim("data/gwas_data/derived/delete_me.hsq", sep = "\t") , 
        data.frame(Source = "Errors", Variance = errors, SE = NA)) %>% 
    mutate(Trait = trait1) %>% select(Trait, everything())
}

# Now run the model for every trait and create a large tibble using map_dfr

if(!file.exists("data/derived/variance_components.csv")){
  variance_components <-
    map_dfr(traits_for_analysis, do_univariate_greml) %>% 
    filter(Source %in% c("V(G)", "V(e)", "Vp", "V(G)/Vp")) %>% 
    mutate(Variance = as.numeric(Variance)) %>% 
    rename(Parameter = Source) %>% 
    as_tibble()
  write_csv(variance_components, file = "data/derived/variance_components.csv")
} else variance_components <- read_csv("data/derived/variance_components.csv")

```



For now we simply don't run models for these traits, so there are no variance estimates for these traits.

$~$

## Wrangle data and save


```{r}
trait_info <- traits %>%
  mutate(Trait = str_replace_all(Trait, "[/]", "_")) %>% 
  select(-trait_value) %>% 
  distinct(Trait, Sex, `Trait guild`, `Trait description`, Reference)

variance_components <- left_join(variance_components, trait_info)

# wrangle so that each variance component is its own column

variance_components_wide <- 
  variance_components %>% 
  pivot_wider(names_from = Parameter,
              values_from = c(Variance, SE)) %>% 
  mutate(across(where(is.numeric), round, 2)) %>% 
  rename(`V(G)` = `Variance_V(G)`,
         `V(e)` = `Variance_V(e)`,
         `Vp` = `Variance_Vp`,
         `V(G)/Vp` = `Variance_V(G)/Vp`)
  
# Below we remove the suffix that denotes the sex the trait was measured in

SNP_heritability <-
  variance_components_wide %>% 
  mutate(Trait = case_when(
           str_ends(Trait, ".f") | str_ends(Trait, ".m")  ~ gsub('.{2}$', '', Trait))) %>% 
  select(Trait, Sex, everything()) %>%  # reorder the columns for the table %>% 
  arrange(Trait)


write_csv(SNP_heritability, file = "data/derived/SNP_heritability_cleaned.csv")
```

$~$

# Table 1

Table 1. Phenotypic variance for the traits in our dataset ($V_p$), SNP variance ($V_{SNP}$), residual variance ($V_e$) and heritability ($h^2_{SNP}$).

```{r}
# Create a function to build HTML searchable tables

my_data_table <- function(df){
  datatable(
    df, rownames=FALSE,
    autoHideNavigation = TRUE,
    extensions = c("Scroller",  "Buttons"),
    options = list(
      autoWidth = TRUE,
      columnDefs = list(list(width = '300px', targets = c(4))),
      dom = 'Bfrtip',
      deferRender=TRUE,
      scrollX=TRUE, scrollY=1000,
      scrollCollapse=TRUE,
      buttons =
        list('pageLength', 'colvis', 'csv', list(
          extend = 'pdf',
          pageSize = 'A4',
          orientation = 'landscape',
          filename = 'Variance_table')),
      pageLength = 1000
    )
  )
}

my_data_table(SNP_heritability)
```

$~$

# Use GCTA to estimate genetic correlations between traits

$~$

Here we use the `gcta64` command `--reml-bivar` to estimate the genetic covariance `(C(G)_tr12)`, i.e. the co-variance explained by the known SNPs in the DGRP, and the genetic correlation (`rG`), in addition to the univariate parameters for trait 1 and trait 2 mentioned above. Note that for traits where the genetic variance is estimated to be low, the model cannot reliably estimate genetic covariance or correlations.

**I haven't run this yet because it will take AGES**
